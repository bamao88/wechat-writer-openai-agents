# OpenAI Agent & MiniMax 集成项目：详细分阶段实施指南

> **真实环境驱动版**  
> 本指南要求每一个开发阶段都必须经历"模拟验证"到"真实 API 闭环"的过程。  
> 所有阶段的最终通过标准均以 **真实环境下的成功响应** 为准。

---

## 第一阶段：核心大脑联通性验证 (Brain Connectivity)

**目标**：确保 Agent SDK 能通过适配层驱动真实的 MiniMax 模型，并建立追踪标识。

### 1.1 环境与追踪初始化

| 环节 | 任务内容 |
|------|----------|
| **任务** | 安装依赖，配置 `.env`，实现 `logger.py`（Trace ID 生成） |
| **模拟环节** | 编写脚本生成 Trace ID 并打印一条带 ID 的模拟日志 |

### 1.2 链路闭环：MiniMax 接入 Agent

**核心任务**：在 `agent.py` 中初始化 `LitellmModel` 并创建基础 Agent。

**模拟闭环**：使用 `MockModel` 或本地字符串模拟，确保 Agent 能走通"接收输入 → 返回输出"的流程。

#### 🎯 真实 API 闭环 (Phase 1 核心)

| 项目 | 内容 |
|------|------|
| **动作** | 发送 `"你好，请确认你的模型名称"` 给 Agent |
| **验收指标** | Agent 返回包含 "MiniMax" 特征的真实文本 |
| **观测指标** | 日志中显示 `provider_latency` 且伴随唯一的 `trace_id` |

---

## 第二阶段：工具调用 (Skill) 深度集成 (Skill Integration)

**目标**：验证 Agent 能在真实对话中精准识别、调用并接收来自 NotebookLM Skill 的数据。NotebookLM Skill代码使用：https://github.com/PleasePrompto/notebooklm-skill 中的相关代码

### 2.1 工具函数开发与单元验证

| 环节 | 任务内容 |
|------|----------|
| **核心任务** | 在 `notebooklm_tool.py` 编写 `run_search` 函数 |
| **模拟闭环** | 直接运行 `test_tools.py`，手动传入参数，验证函数能否返回预期的素材字符串 |

### 2.2 链路闭环：Agent 成功挂载并触发 Skill

**核心任务**：将工具注册到 Agent，并调试指令（Prompt）。

**模拟闭环**：使用 Mock 响应模拟模型下达 `tool_calls` 指令，验证 `tools.py` 是否能正确承接并执行。

#### 🎯 真实 API 闘环 (Phase 2 核心)

| 项目 | 内容 |
|------|------|
| **动作** | 向 Agent 提问 `"请搜索知识库中关于 XX 的最新动态"` |

**验收指标**：

- [x] **真实触发**：在控制台看到 `query_notebooklm` 的运行日志
- [x] **成功回收**：Agent 接收到真实搜索素材

**观测指标**：记录 `tool_latency`

---

## 第三阶段：全链路闭环与可观测性加固 (Full Flow & Telemetry)

**目标**：在真实环境下完成"从标题到长文"的完整闭环，并产出质量、性能与成本报告。

### 3.1 业务流程闭环 (`main.py`)

| 环节 | 任务内容 |
|------|----------|
| **核心任务** | 实现完整的"输入 → 搜索 → 生成 → 保存"逻辑 |
| **模拟闭环** | 用预设的搜索结果运行 Agent，验证文章保存路径和格式是否正确 |

### 3.2 真实环境端到端闭环

**核心任务**：运行 `tests/test_real.py`，输入真实标题。

#### 🎯 验收指标

| 指标 | 要求 |
|------|------|
| **任务完成** | 产生一篇引用了搜索素材的深度长文 |
| **追踪完整** | 生成一份包含以下内容的完整报告 |

```
┌─────────────────────────────────────┐
│  Trace Report                       │
├─────────────────────────────────────┤
│  trace_id:        abc-123-xyz       │
│  provider_latency: 1.2s             │
│  tool_latency:     0.8s             │
│  total_tokens:     2,450            │
│  cost:             $0.012           │
└─────────────────────────────────────┘
```

---

## 各阶段验收标准 (Real-World KPI)

| 阶段 | 核心验证点 | 真实环境通过指标 |
|------|------------|------------------|
| **阶段 1** | MiniMax 接入 | ✅ Agent 打印出来自 MiniMax 真实 API 的对话响应 |
| **阶段 2** | Skill 挂载 | ✅ 观测到 Agent 真实触发了搜索函数，并成功拿回并理解了素材 |
| **阶段 3** | 全链路生成 | ✅ 产出基于检索素材的长文章，且 Trace 报告中的各项指标（延迟、成本）非零 |

---

## 风险防御特别说明

| 失败阶段 | 常见原因 | 排查方向 |
|----------|----------|----------|
| **阶段 1 失败** | API Key 或 LiteLLM 模型名设置错误 | 检查 `.env` 配置和模型名拼写 |
| **阶段 2 失败** | MiniMax 对 `tool_role` 的协议适配问题 | 检查日志中的 Payload 格式 |

---

## 相关文档

- [`project-spec.md`](./project-spec.md) - 项目规范与目录结构
- [`state.md`](./state.md) - 进度与状态管理
